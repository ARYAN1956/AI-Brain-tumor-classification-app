import React, { useEffect, useState, useRef } from "react";
import jsPDF from "jspdf";
import html2canvas from "html2canvas";
import AppNavbar from "../components/AppNavbar";


const tumorDescriptions = {
  Glioma: "Gliomas are aggressive brain tumors that originate from glial cells. Early intervention is critical for effective management.",
  Meningioma: "Meningiomas are generally slow-growing tumors arising from the meninges. Though mostly benign, treatment may be needed.",
  Pituitary: "Pituitary tumors affect hormonal balance and can often be treated successfully with surgery or medication.",
  NoTumor: "The AI model did not detect any signs of tumor in this scan. Clinical consultation is still advised for confirmation.",
};

const recommendations = [
  "Consult a neurologist or neurosurgeon with this report.",
  "Consider an MRI with contrast or biopsy if necessary.",
  "Do not rely solely on AI-based diagnosis for treatment decisions.",
  "Maintain follow-up imaging based on specialist advice",
];

const Result = () => {
  const [result, setResult] = useState(null);
  const [image, setImage] = useState(null);
  const contentRef = useRef();

  useEffect(() => {
    const savedResult = JSON.parse(localStorage.getItem("result"));
    const preview = localStorage.getItem("preview");
    if (savedResult) {
      setResult(savedResult);
      setImage(preview);
    }
  }, []);

  const handleDownload = async () => {
    const element = contentRef.current;
    const canvas = await html2canvas(element, {
      scale: 2,
      useCORS: true,
      scrollY: -window.scrollY,
      windowWidth: 794,
      windowHeight: 1123,
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * pageWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pageWidth, imgHeight);
    pdf.save(`MRI_Report_${result.name}.pdf`);
  };

  if (!result) return <p style={styles.noResult}>No result found.</p>;

  return (
    <>
      <AppNavbar />
      <div style={styles.wrapper}>
        <div ref={contentRef} id="pdf-content" style={styles.card}>
          <div style={styles.topBar}></div>

          <div style={styles.header}>
            <img src="/assets/logo.png" alt="logo" style={styles.logo} />
            <div style={{ flex: 1 }}>
              <h2 style={styles.title}><em>IntelliCrux-Net++ Model</em></h2>
              <p style={styles.subtitle}>Brain Tumor Prediction Report by Trained AI Model</p>
              <p style={styles.subtext}>A brain tumor detection report generated by the developed AI model from SRM Institute of Science & Technology, KTR ‚Äî In-house Project</p>
            </div>
          </div>

          <hr style={styles.hrLine} />

          <div style={styles.patientInfo}>
            <div style={styles.infoBlock}>
              <p><b>Patient name:</b> {result.name}</p>
              <p><b>Patient ID:</b> #{Math.floor(Math.random() * 9000) + 1000}</p>
              <p><b>Gender:</b> {result.gender}</p>
              <p><b>Email:</b> {result.email}</p>
            </div>
            <div style={styles.infoBlock}>
              <p><b>Age:</b> {result.age}</p>
              <p><b>Phone No:</b> {Math.floor(1000000000 + Math.random() * 900000000)}</p>
              <p><b>Date:</b> {result.date}</p>
              <p><b>Time:</b> {new Date().toLocaleTimeString()}</p>
            </div>
            <div style={styles.scanImage}>
              <img src="/assets/brain-scan.png" alt="scan" style={styles.scanLogo} />
            </div>
          </div>

          <div style={styles.sectionBox}>
            <h3 style={styles.sectionTitle}>Prediction MRI Report Generated by AI Model</h3>
            <div style={styles.resultBlock}>
              <div style={styles.resultLeft}>
                <p><b>Prediction Type:</b> Tumor</p>
                <p><b>Tumor Name:</b> {result.prediction}</p>
                <p><b>Confidence Score:</b> {result.confidence}%</p>
              </div>
              <div style={styles.resultRight}>
                <p><b>Predicted Image:</b></p>
                {image && <img src={image} alt="Prediction" style={styles.mriImage} />}
              </div>
            </div>
          </div>

          <div style={styles.notes}>
            <h4>üß† Clinical Interpretation:</h4>
            <p>{tumorDescriptions[result.prediction]}</p>
          </div>

          <div style={styles.notes}>
            <h4>üìù Recommended Next Steps:</h4>
            <ul>
              {recommendations.map((step, idx) => (
                <li key={idx}>{step}</li>
              ))}
            </ul>
          </div>

          <p style={styles.note}>
            <strong>NOTE:</strong> This report is generated by AI Trained Model. Don‚Äôt rely solely on it. Please consult a doctor for more clarity.
          </p>

          <div style={styles.bottomBar}></div>
          <footer style={styles.footer}>@By: Aryan and Team</footer>
        </div>

        <div style={styles.buttonGroup}>
          <button onClick={handleDownload} style={styles.downloadBtn}>üìÑ Download PDF</button>
        </div>
      </div>
    </>
  );
};

const styles = {
  wrapper: {
    maxWidth: "880px",
    margin: "2rem auto",
    padding: "1rem",
    fontFamily: "'Segoe UI', sans-serif",
    color: "#000",
  },
  card: {
    background: "#fff",
    borderRadius: "10px",
    padding: "1.5rem",
    boxShadow: "0 0 12px rgba(0,0,0,0.15)",
    position: "relative",
  },
  topBar: {
    height: "12px",
    backgroundColor: "#000053",
    borderTopLeftRadius: "10px",
    borderTopRightRadius: "10px",
    marginBottom: "10px",
  },
  bottomBar: {
    height: "8px",
    backgroundColor: "#000053",
    borderBottomLeftRadius: "10px",
    borderBottomRightRadius: "10px",
    marginTop: "30px",
  },
  hrLine: {
    margin: "1rem 0",
    border: "none",
    borderTop: "10px solid #000053",
  },
  header: {
    display: "flex",
    alignItems: "center",
    gap: "1.5rem",
    paddingBottom: "1rem",
    marginBottom: "1rem",
  },
  logo: {
    width: "65px",
    height: "65px",
  },
  title: {
    fontSize: "20px",
    color: "#000053",
    margin: 0,
  },
  subtitle: {
    fontSize: "16px",
    fontWeight: "600",
    margin: "0.3rem 0",
  },
  subtext: {
    fontSize: "12px",
    color: "#555",
  },
  patientInfo: {
    display: "flex",
    justifyContent: "space-between",
    gap: "1rem",
    marginBottom: "1.2rem",
  },
  infoBlock: {
    flex: 1,
    fontSize: "14px",
    lineHeight: "1.6",
  },
  scanImage: {
    display: "flex",
    alignItems: "center",
  },
  scanLogo: {
    width: "100px",
    borderRadius: "6px",
  },
  sectionBox: {
    border: "1px solid #000053",
    padding: "1rem",
    borderRadius: "8px",
    marginBottom: "1.2rem",
  },
  sectionTitle: {
    backgroundColor: "#000053",
    color: "#fff",
    padding: "0.5rem",
    borderRadius: "6px",
    textAlign: "center",
    marginBottom: "1rem",
  },
  resultBlock: {
    display: "flex",
    justifyContent: "space-between",
    gap: "2rem",
  },
  resultLeft: {
    flex: 1,
    fontSize: "14px",
  },
  resultRight: {
    flex: 1,
    textAlign: "center",
  },
  mriImage: {
    maxWidth: "100%",
    maxHeight: "180px",
    borderRadius: "6px",
    border: "1px solid #ccc",
  },
  notes: {
    background: "#e9ecf1ff",
    padding: "1rem",
    borderRadius: "6px",
    marginTop: "1rem",
    fontSize: "14px",
  },
  note: {
    fontSize: "12px",
    color: "#777",
    marginTop: "1rem",
    borderTop: "1px dashed #ccc",
    paddingTop: "0.6rem",
  },
  footer: {
    marginTop: "0.8rem",
    textAlign: "center",
    fontWeight: 600,
    fontSize: "13px",
    color: "#333",
  },
  downloadBtn: {
    padding: "0.7rem 1.5rem",
    backgroundColor: "#000053",
    color: "#fff",
    fontSize: "1rem",
    borderRadius: "6px",
    border: "none",
    cursor: "pointer",
    fontWeight: "bold",
  },
  buttonGroup: {
    marginTop: "2rem",
    textAlign: "center",
  },
  noResult: {
    textAlign: "center",
    marginTop: "5rem",
    fontSize: "18px",
    color: "#999",
  },
};

export default Result;
